name: Build and Deploy
on: 
  push:
    branches:
      - main
    paths-ignore:
      - "**/README.md"
      - "**/LICENSE"
      - "**/LICENSE*"
      - "**/CONTRIBUTING.md"
      - "**/.gitignore"
      - "**/netlify.toml"

jobs:
  build:
    name: Build
    runs-on: ubuntu-20.04
    env:
      TZ: Asia/Jakarta
      HUGO_ENV: production

    steps:
    - name: Checkout the Code
      uses: actions/checkout@v2
      with:
        fetch-depth: '0'
        submodules: 'true'

    - name: Install and Set up Locales and Other Packages
      run: |
        case "$(curl -s --max-time 3 -I http://azure.archive.ubuntu.com | sed 's/^[^ ]*  *\([0-9]\).*/\1/; 1q')" in
          [23]) echo "The Repository HTTP Server is up"
                if nc -zw3 azure.archive.ubuntu.com 80; then
                  echo "The Repository Server has been connected successfully"
                else
                  echo "The Repository server is down, changing the Repository Server. Please wait....."
                  sudo sed -i 's|http://azure.archive.ubuntu.com/ubuntu/|https://mirror.b-cdn.net/ubuntu/|g' /etc/apt/sources.list
                  sudo sed -i 's|http://security.ubuntu.com/ubuntu|https://mirror.b-cdn.net/ubuntu/|g' /etc/apt/sources.list
                  sudo sed -i 's|http://ppa.launchpad.net|https://mirrorppa.b-cdn.net|g' /etc/apt/sources.list.d/*.list
                fi;;
          *) echo "The Repository HTTP Server is down, changing the Repository Server. Please wait....."
             sudo sed -i 's|http://azure.archive.ubuntu.com/ubuntu/|https://mirror.b-cdn.net/ubuntu/|g' /etc/apt/sources.list
             sudo sed -i 's|http://security.ubuntu.com/ubuntu|https://mirror.b-cdn.net/ubuntu/|g' /etc/apt/sources.list
             sudo sed -i 's|http://ppa.launchpad.net|https://mirrorppa.b-cdn.net|g' /etc/apt/sources.list.d/*.list;;
        esac
        sudo apt update
        sudo apt install locales locales-all pigz
        sudo sed -i 's/id_ID\s.*$/id_ID id_ID.utf8/g' /usr/share/locale/locale.alias
        sudo sed -i 's/# id_ID\.UTF-8/id_ID\.UTF-8/' /etc/locale.gen
        sudo update-locale LANG=C.UTF-8 LC_MESSAGES=POSIX
        DEBIAN_FRONTEND=noninteractive sudo -E dpkg-reconfigure locales
        sudo ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
    
    - name: Install and Set up Hugo Extended
      run: |
        HUGO_VERSION="$(curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | grep tag_name | cut -d 'v' -f2 | cut -d'"' -f1)"
        cd /tmp/
        wget https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz
        tar -xzf hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz
        chmod +x hugo
        sudo mv hugo /usr/local/bin/ && sudo chown root:root /usr/local/bin/hugo
        cd ${GITHUB_WORKSPACE}
        which hugo && hugo version
        git ls-tree -rtl HEAD:content/post --full-tree > /tmp/post-tree.hash

    - name: Set up Hugo Resources Cache
      uses: actions/cache@v2
      with:
        path: |
          ./cache
          ./resources
        key: v1-hugo-${{ hashFiles('/tmp/post-tree.hash') }}-${{ hashFiles('**/config.yaml') }}
        restore-keys: | 
          - v1-hugo-${{ hashFiles('/tmp/post-tree.hash') }}-${{ hashFiles('**/config.yaml') }}
          - v1-hugo-${{ hashFiles('/tmp/post-tree.hash') }}-

    - name: Building the Blog HTML
      run: |
        rm static/robots_preview
        hugo --minify --enableGitInfo --cacheDir ${PWD}/cache
        tar cvf - ./public | pigz -9 > files.tar.gz

    - name: Upload Output File to Artifact
      uses: actions/upload-artifact@v2
      with:
        name: site-outputs
        path: files.tar.gz
        retention-days: 1
  
  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-20.04
    steps:
    - name: Download Output File from Artifact
      uses: actions/download-artifact@v2
      with:
        name: site-outputs

    - name: Decompressing Files and Installing lftp
      run: |
        tar -xvzf files.tar.gz
        sudo -- sh -c 'apt update; apt install -y lftp'
    
    - name: Deploying with lftp and Purging Bunny.net Pullzone Cache
      env:
        FTP_USER: ${{ secrets.BUNNY_STORAGE_USERNAME }}
        FTP_PASS: ${{ secrets.BUNNY_STORAGE_PASSWORD }}
        BUNNY_PULLZONE_ID: ${{ secrets.BUNNY_PULLZONE_ID }}
        BUNNY_API_KEY: ${{ secrets.BUNNY_API_KEY }}
      run: |
        lftp -e "open storage.bunnycdn.com; user ${FTP_USER} ${FTP_PASS}; mirror -R --parallel=10 --verbose --only-newer ./public /${FTP_USER}; bye"
        RESPONSE_CODE=$(curl -so /dev/null -I -w "%{http_code}" -X POST -H "content-length: 0" -H "Content-Type: application/json" -H "Accept: application/json" -H "AccessKey: ${BUNNY_API_KEY}" 'https://api.bunny.net/pullzone/${BUNNY_PULLZONE_ID}/purgeCache' | head -n 1 | cut -d$' ' -f2)
        if [ "${RESPONSE_CODE}" -gt 299 ]; then
          echo "Failed to sending purge request, purge it by yourself!"
        else
          echo "Sending Purge Request is Successfully, the CDN Cache will be purged soon!"
        fi
        echo "${RESPONSE_CODE}"
