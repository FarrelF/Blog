{{- $image := .Page.Resources.GetMatch (printf "%s" (.Destination | safeURL)) -}}

{{- if $image -}}
	{{- $ImageURL := "" -}}
	{{- if and (.Page.Site.Params.CDN.Images.URL) (eq hugo.IsProduction true) -}}
		{{- $ImageURL = .Page.Site.Params.CDN.Images.URL -}}
	{{- end -}}
	{{- $alt := .PlainText | safeHTML -}}
	<figure style="flex-grow: {{ div (mul $image.Width 100) $image.Height }}; flex-basis: {{ div (mul $image.Width 240) $image.Height }}px">
		<a href="{{ $image.RelPermalink }}" data-size="{{ $image.Width }}x{{ $image.Height }}">
			{{- $Width := $image.Width -}}
			{{- $Height := $image.Height -}}
			{{- $Srcset := "" -}}
			{{- $Permalink := printf "%s%s" $ImageURL $image.RelPermalink -}}

			{{- if (default true .Page.Site.Params.imageProcessing.content.enabled) -}}
				{{- $small := $image.Resize "480x" -}}
				{{- $big := $image.Resize "1024x" -}}
				{{- $Srcset = printf "%s%s 480w, %s%s 1024w" $ImageURL $small.RelPermalink $ImageURL $big.RelPermalink -}}
			{{- end -}}
			
			<img src="{{ $Permalink }}"
				{{ with $Srcset }}srcset="{{ . }}"{{ end }}
				width="{{ $Width }}"
				height="{{ $Height }}"
				loading="lazy"
				{{ with $alt }}alt="{{ . }}"{{ end }}>
		</a>
		{{ with $alt }}
		<figcaption>{{ . | markdownify }}</figcaption>
		{{ end }}
	</figure>
{{- else -}}
	<img src="{{ .Destination | relURL | safeURL }}" alt="{{ .Text }}" {{ with .Title }} title="{{ . }}"{{ end }} />
{{- end -}}
