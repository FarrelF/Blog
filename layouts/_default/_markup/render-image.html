{{- $baseURL := urls.Parse .Page.Site.BaseURL -}}
{{- $StaticallyImgixURL := print "//cdn.statically.io/img/" $baseURL.Host -}}
{{- $StaticallyWebpImgixURL := print $StaticallyImgixURL "/f=auto" -}}
{{- $image := .Page.Resources.GetMatch (printf "%s" (.Destination | safeURL)) -}}

{{- if $image -}}
	{{- $alt := .PlainText | safeHTML -}}
	<figure style="flex-grow: {{ div (mul $image.Width 100) $image.Height }}; flex-basis: {{ div (mul $image.Width 240) $image.Height }}px">
		<a href="{{ $image.RelPermalink }}" data-size="{{ $image.Width }}x{{ $image.Height }}">
			{{- $Width := $image.Width -}}
			{{- $Height := $image.Height -}}
			{{- $Srcset := "" -}}
			{{- $Permalink := "" -}}
			{{- if and (.Page.Site.Params.StaticallyCDN.Imgix) (ne hugo.Environment "development") -}}
				{{- $Permalink = printf "%s%s" $StaticallyImgixURL $image.RelPermalink -}}
				{{- if eq .Page.Site.Params.StaticallyCDN.Imgix.autowebp true -}}
					{{- $Permalink = printf "%s%s" $StaticallyWebpImgixURL $image.RelPermalink -}}
				{{- end -}}
			{{- else -}}
				{{- $Permalink = $image.RelPermalink -}}
			{{- end -}}

			{{- if (default true .Page.Site.Params.imageProcessing.content.enabled) -}}
				{{- $small := $image.Resize "480x" -}}
				{{- $big := $image.Resize "1024x" -}}
				{{- if and (.Page.Site.Params.StaticallyCDN.Imgix) (ne hugo.Environment "development") -}}
					{{- $Srcset = printf "%s%s 480w, %s%s 1024w" $StaticallyImgixURL $small.RelPermalink $StaticallyWebpImgixURL $big.RelPermalink -}}
					{{- if eq .Page.Site.Params.StaticallyCDN.Imgix.autowebp true -}}
						{{- $Srcset = printf "%s%s 480w, %s%s 1024w" $StaticallyWebpImgixURL $small.RelPermalink $StaticallyImgixURL $big.RelPermalink -}}
					{{- end -}}
				{{ else }}
					{{- $Srcset = printf "%s 480w, %s 1024w" $small.RelPermalink $big.RelPermalink -}}
				{{- end -}}
			{{- end -}}
			
			<img src="{{ $Permalink }}"
				{{ with $Srcset }}srcset="{{ . }}"{{ end }}
				width="{{ $Width }}"
				height="{{ $Height }}"
				loading="lazy"
				{{ with $alt }}alt="{{ . }}"{{ end }}>
		</a>
		{{ with $alt }}
		<figcaption>{{ . | markdownify }}</figcaption>
		{{ end }}
	</figure>
{{- else -}}
	<img src="{{ .Destination | safeURL }}" alt="{{ .Text }}" {{ with .Title }} title="{{ . }}"{{ end }} />
{{- end -}}